---
layout: post
title: "类pinterest网站中图片墙布局中的最优化问题"
date: "2012-05-02 23:50"
category: improvement
tags:
    - improvement
    - pinterest
---
pinterest最近很火，国内也有很多公司也在做类似产品,我们团队年初也做了一个：[人人逛街](http://j.renren.com)。小菜鸟作为一个主要开发人员，在整个架构设计上遇到了很多问题，身边经验丰富的人不少，架构上的东西在请教及重构中慢慢完善。但在细节上，还有很多小问题没有很好的解决方法，其中一个就是今天要讨论的图片墙布局最优化问题。

具体描述为: **一个瀑布流页面（图片墙）有等宽w的C列，有MxN个宽为w，高度h不定的渲染好的层元素（DIV），问对于每次后台给出的M个元素，如何排放排放能使页面总体看上去更美观?**

问题提出的背景是，在一个读图网站，如果带宽不够的话，有一定概率给用户展示不出图片，如果图片位置没有排放匀称个话，更有可能给用户呈现出大块大块的空白，给用户极为不友好的体验。在做人人逛街前，也调研了一下，但目前为止，没有发现国内有哪个网站在这方面有大的改观。下面是几个比较火存在该问题的几个网站的截图：

> pinterest
>   ![pinterest](/images/ping.png)
>
> 知美
>   ![zhimei](/images/zhimei.png)
>
> 花瓣
>   ![huaban](/images/huaban.png)

分析下描述的问题，会发现这个问题还是不够抽象，因为我们还不知道美观是如何定义的。美观的定义的确比较麻烦，但直观感觉不美观的原因就是图片墙的高度参差不齐，用数学语言描述就是高度的方差太大。可能用方差来定义一个布局是否美观不太准确，但为了分析问题，暂且这么设定。明确了优化目标，在寻找优化手段时还需要明确可能利用的条件，在这个问题中，最关键的条件是：渲染后的M个元素是否和后台给出的M个元素保存一样的序。

如果需要保证一样的序，那么每个元素的位置已经固定，所以不存在元素调整的问题，那么，翻页可能就是一个解决方式。翻页可以解决是因为方差的累积主要源于某几个（实际情况下基本就是某一个）元素的高度特别大（比如是平均高度2-3倍），如果一直累积的话，最后页面就大片留白，所以在适当的几次下拉后翻页会将减小大片留白的概率，即使出现大片留白，通过翻页也能消除留白的持续影响。

若是无序，近似的解决的方式可能就比较多，其中比较简单的就是贪心算法，但无法保证最优解，大概思路就是**在渲染每个元素前，找出已渲染的高度最小的列，并将该元素渲染到该列最后**。但如果想要一个确定性的算法，基本就不太可能，因为如果我们再对问题抽象，就可以看出这个问题应该是个NPC问题:

> 给定数列K有N个数，需要数列分成W组(G1，G2 ... Gw)，且各组和组成数组SUM sum1,sum2...sumw,求min(D(sum).
> 当然，怎么证明是NPC问题，已经不会…但可以用DP来估算一下计算量：

> dp\[k]\[h1]\[h2]..\[hw] 表示前K个数分成W组的状态为h1,h2...hw时候可达，path\[k]\[h1]\[h2]..\[hw] 表示前K个数到达该状态时的路径，状态转移方程为：
>
>dp\[k]\[h1]\[h2]...\[hw] = dp\[k]\[h1]\[h2]...\[hw] or dp\[k-1]\[h1]\[hi-h]...\[hw] , 其中 1<= i <= w)
>
>path\[k]\[h1]\[h2]...\[hw]=path\[k-1]\[h1]\[hi-h]...\[hw] +"->"+i,其中 dp\[k-1]\[h1]\[hi-h]...\[hw]=true and dp\[k]\[h1]\[h2]...\[hw]在1)前为false


估算下空间和计算量：共有W维，每维的取值有N!个，则有K((N!)^W)个状态…如果循环利用数组，那么也有2((N!)^W)个状态。对于时间上，对于第i数，最多都有((i-1)!)^W次转移计算，总计算次数为sigma{((i-1)!)^W},1<=i<=N,这是多少呢？反正我算不出来，但绝对是那种不用算的多~~

有些同学在学算法的时候觉得没什么用，但真不是这样的，工作应用中，其实还是比较多需要算法知识的，深究下去的话，肯定会越发觉得知识不够用的！
